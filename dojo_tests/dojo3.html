<html>
<head>
<title>Dojo example</title>

<link href="css/dojo_style.css" type="text/css" rel="stylesheet" media="all" />

    
<script type="text/javascript" src="dojo-1.3.1/dojo/dojo.js"
	    djConfig="parseOnLoad:true, isDebug:true"></script>


<script>
dojo.require("dojox.gfx");
dojo.require("dojox.gfx.move");
dojo.require("dijit.Tooltip");

var container = null;
var container_position = null;
var surface = null;

var nodes = Array('a', 'b', 'c', 'd', 'e');

var edges = Array(Array('c', 'd') , Array('e', 'd') , Array('a', 'e') , Array('a', 'b') , Array('b', 'c') );

var labels = Array('Node 1', 'Node 2', 'Node 3', 'Node 4', 'Node 5');

NodeMover = dojo.extend(dojox.gfx.Mover, {
        // mouse event processors
        onMouseMove: function(e){
                // summary: event processor for onmousemove
                // e: Event: mouse event
                var x = e.clientX;
                var y = e.clientY;
                var delta_x = e.clientX - this.lastX;
                var delta_y = e.clientY - this.lastY;
               
                this.shape.applyTransform({dx: delta_x, dy: delta_y});
                var newPoint = dojox.gfx.matrix.multiplyPoint(this.shape.matrix, this.shape.position[0], this.shape.position[1]);

                for(i = 0; i < this.shape.in_arcs.length; i++) {
                        var arc = this.shape.in_arcs[i];
                        arc.setShape({x1: arc.shape.x1, y1: arc.shape.y1, x2: newPoint.x, y2: newPoint.y + 15});
                }

                for(i = 0; i < this.shape.out_arcs.length; i++) {
                        var arc = this.shape.out_arcs[i];
                        arc.setShape({x1: newPoint.x, y1: newPoint.y + 15, x2: arc.shape.x2, y2: arc.shape.y2});
                }
                this.lastX = x;
                this.lastY = y;
                dojo.stopEvent(e);
        },
        // utilities
        onFirstMove: function(){
                // summary: it is meant to be called only once
                dojo.disconnect(this.events.pop());
        },
        destroy: function(){
                // summary: stops the move, deletes all references, so the object can be garbage-collected
                dojo.forEach(this.events, dojo.disconnect);
                // undo global settings
                dojo.publish("/gfx/move/stop", [this]);
                dojo.removeClass(dojo.body(), "dojoMove");
                // destroy objects
                this.events = this.shape = null;
        }
});

function drawVertex() {
        var cx = 200, cy = 20, r = 5;
        var dir = -130;
        for(i = 0; i < nodes.length; i++) {
                var group = surface.createGroup();
                var shape = surface.createRect({x: cx - 40, y: cy, width: 100, height: 30, r: r}).setFill([70, 180, 27, 1.0]).moveToBack();
                var text = surface.createText({x: cx - 35, y: cy + 20, text: labels[i]}).setFill("black").setFont("Arial 16");
                group.add(shape);
                group.add(text);
                group.out_arcs = Array();
                group.in_arcs = Array();
                group.position = Array(cx, cy);
                group.extern_id = nodes[i];
                group.viewDetails = function(e) {
                        window.location.href = 'detail.php?id=' + this.extern_id;
                };
                group.connect("ondblclick", group, "viewDetails");

                edges[i].group = group;
               
                new dojox.gfx.Moveable(group, {mover: NodeMover});
                cy += 55;
                if(i % 2 == 0) dir = -dir;
                cx += dir;
        }
}

function drawEdges() {
        for(i = 0; i < nodes.length; i++) {
                nodo_actual = edges[i];
                for(j = 0; j < nodo_actual.length; j++) {
                        var key_destino = nodo_actual[j];
                        for(k = 0; k < nodes.length; k++) {
                                if(key_destino == nodes[k]) {
                                        break;
                                }
                        }
                        nodo_destino = edges[k];
                        var arc = surface.createLine({x1: nodo_actual.group.position[0],
                                          y1: nodo_actual.group.position[1] + 15,
                                          x2: nodo_destino.group.position[0],
                                          y2: nodo_destino.group.position[1] + 15})
                                .setFill("black")
                                .setStroke({width: 3})
                                .moveToBack();       
                        nodo_actual.group.out_arcs[nodo_actual.group.out_arcs.length] = arc;
                        nodo_destino.group.in_arcs[nodo_destino.group.in_arcs.length] = arc;
                        arc.previous = nodo_actual.group;
                        arc.next = nodo_destino.group;
                }
        }       
}

function initGfx(){
        container = dojo.byId("gfx_holder");
        container_position = dojo.coords(container, true);
        surface = dojox.gfx.createSurface(container, 800, 600);

        drawVertex();
        drawEdges();
       
        // cancel text selection and text dragging
        dojo.connect(container, "ondragstart",   dojo, "stopEvent");
        dojo.connect(container, "onselectstart", dojo, "stopEvent");
}

dojo.addOnLoad(initGfx);

</script>
<body>
</body>
</html>